<section class="qc-page">
  <!-- List View -->
  <div class="list-view" *ngIf="!showDialog">
    <header>
      <div>
        <p class="eyebrow">Product inspection plan</p>
        <h1>Plan Builder</h1>
      </div>
      <button type="button" class="add-button" (click)="openDialog()">Add new</button>
    </header>

    <section class="table-shell">
      <div class="table-state" *ngIf="isLoading">Loading plans…</div>
      <div class="table-state error" *ngIf="!isLoading && loadError">{{ loadError }}</div>

      <table *ngIf="!isLoading && !loadError && records.length">
        <thead>
          <tr>
            <th>Item ID</th>
            <th>Description</th>
            <th>Plan Type</th>
            <th>Frequency</th>
            <th>Customer</th>
            <th>Prepared By</th>
            <th>Plan Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of records">
            <td>{{ record.itemId }}</td>
            <td>{{ record.itemDescription }}</td>
            <td>{{ record.planType || '—' }}</td>
            <td>{{ record.frequency || '—' }}</td>
            <td>{{ record.customer || '—' }}</td>
            <td>{{ record.preparedBy || '—' }}</td>
            <td>{{ record.planDate | date : 'shortDate' }}</td>
            <td>
              <button type="button" class="detail-button" (click)="viewRecord(record)">Detail</button>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="table-state" *ngIf="!isLoading && !loadError && !records.length">
        No product inspection plans recorded yet.
      </div>
    </section>
  </div>

  <!-- Full Page Form View -->
  <div class="form-view" *ngIf="showDialog">
    <header class="form-header">
      <h2>{{ isReadOnly ? 'Plan Details' : 'Add Product Inspection Plan' }}</h2>
      <button type="button" class="close-button" (click)="closeDialog()" aria-label="Close">×</button>
    </header>

    <form class="full-page-form" [formGroup]="form" (ngSubmit)="submit()">
      <section class="form-section">
        <div class="form-grid">
          <label>
            <span>Item ID *</span>
            <input type="text" formControlName="itemId" />
          </label>
          <label>
            <span>Item description *</span>
            <input type="text" formControlName="itemDescription" />
          </label>
          <label>
            <span>Plan type</span>
            <input type="text" formControlName="planType" />
          </label>
          <label>
            <span>Frequency</span>
            <input type="text" formControlName="frequency" />
          </label>
          <label>
            <span>Customer</span>
            <input type="text" formControlName="customer" />
          </label>
          <label>
            <span>Contact person</span>
            <input type="text" formControlName="contactPerson" />
          </label>
          <label>
            <span>Supplier / plant</span>
            <input type="text" formControlName="supplierPlant" />
          </label>
          <label>
            <span>Customer approval ref.</span>
            <input type="text" formControlName="customerApproval" />
          </label>
          <label>
            <span>Doc number</span>
            <input type="text" formControlName="docNumber" />
          </label>
          <label>
            <span>Plan date</span>
            <input type="date" formControlName="planDate" />
          </label>
          <label>
            <span>Sample size</span>
            <input type="number" formControlName="sampleSize" />
          </label>
          <label>
            <span>Prepared by</span>
            <input type="text" formControlName="preparedBy" />
          </label>
          <label>
            <span>Revision number</span>
            <input type="text" formControlName="revisionNumber" />
          </label>
        </div>
      </section>

      <section class="form-section">
        <div class="section-header-row">
          <h3 class="section-title">Plan rows</h3>
          <button type="button" class="add-row-button" (click)="addDetailRow()" [disabled]="isReadOnly">+ Add row</button>
        </div>

        <div class="detail-items-container">
          <div class="detail-item-card" *ngFor="let group of details.controls; let i = index" [formGroup]="group">
            <div class="detail-item-header">
              <span class="item-number">#{{ i + 1 }}</span>
              <button
                type="button"
                class="remove-item-button"
                (click)="removeDetailRow(i)"
                [disabled]="isReadOnly || details.length === 1"
              >
                Remove
              </button>
            </div>

            <div class="detail-fields-grid">
              <label>
                <span>Param type</span>
                <input type="text" formControlName="parameterType" />
              </label>
              <label>
                <span>Parameter *</span>
                <input type="text" formControlName="parameterName" />
              </label>
              <label>
                <span>Specifications *</span>
                <input type="text" formControlName="specifications" />
              </label>
              <label>
                <span>Spec characteristics *</span>
                <input type="text" formControlName="specCharacteristics" />
              </label>
              <label>
                <span>Control method</span>
                <input type="text" formControlName="controlMethod" />
              </label>
              <label>
                <span>Freq type</span>
                <input type="text" formControlName="frequencyType" />
              </label>
              <label>
                <span>Freq value</span>
                <input type="text" formControlName="frequencyValue" />
              </label>
              <label>
                <span>Sample size</span>
                <input type="number" formControlName="sampleSize" />
              </label>
              <label>
                <span>Machine no.</span>
                <input type="text" formControlName="machineNo" />
              </label>
              <label>
                <span>Tool no.</span>
                <input type="text" formControlName="toolNo" />
              </label>
              <label>
                <span>Inspection method</span>
                <input type="text" formControlName="inspectionMethod" />
              </label>
              <label>
                <span>Reaction plan</span>
                <input type="text" formControlName="reactionPlan" />
              </label>
              <label class="full-width">
                <span>Corrective action</span>
                <input type="text" formControlName="correctiveAction" />
              </label>
            </div>
          </div>
        </div>
      </section>

      <section class="form-section">
        <label class="full-width">
          <span>Remarks</span>
          <textarea formControlName="remarks" rows="2"></textarea>
        </label>
      </section>

      <div class="form-actions">
        <button type="button" class="secondary" (click)="closeDialog()">
          {{ isReadOnly ? 'Close' : 'Cancel' }}
        </button>
        <button
          *ngIf="!isReadOnly"
          type="submit"
          class="primary"
          [disabled]="isSaving"
        >
          {{ isSaving ? 'Saving…' : 'Save plan' }}
        </button>
        <p class="error" *ngIf="saveError">{{ saveError }}</p>
      </div>
    </form>
  </div>
</section>

