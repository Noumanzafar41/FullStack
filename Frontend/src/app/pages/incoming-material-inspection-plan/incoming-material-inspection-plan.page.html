<section class="qc-page">
  <!-- List View -->
  <div class="list-view" *ngIf="!showDialog">
    <header>
      <div>
        <p class="eyebrow">Incoming material inspection plan</p>
        <h1>Plan Register</h1>
      </div>
      <button type="button" class="add-button" (click)="openDialog()">Add new</button>
    </header>

    <section class="table-shell">
      <div class="table-state" *ngIf="isLoading">Loading plans…</div>
      <div class="table-state error" *ngIf="!isLoading && loadError">{{ loadError }}</div>

      <table *ngIf="!isLoading && !loadError && records.length">
        <thead>
          <tr>
            <th>Item ID</th>
            <th>Description</th>
            <th>Doc #</th>
            <th>Doc Date</th>
            <th>Revision</th>
            <th>Prepared By</th>
            <th>Lines</th>
            <th>Created At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of records">
            <td>{{ record.itemId }}</td>
            <td>{{ record.itemDescription }}</td>
            <td>{{ record.docNumber || '—' }}</td>
            <td>{{ record.docDate | date : 'shortDate' }}</td>
            <td>{{ record.revisionNumber || '—' }}</td>
            <td>{{ record.preparedBy || '—' }}</td>
            <td>{{ record.details?.length || 0 }}</td>
            <td>{{ record.createdAt | date : 'short' }}</td>
            <td>
              <button type="button" class="detail-button" (click)="viewRecord(record)">Detail</button>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="table-state" *ngIf="!isLoading && !loadError && !records.length">
        No incoming material inspection plans recorded yet.
      </div>
    </section>
  </div>

  <!-- Full Page Form View -->
  <div class="form-view" *ngIf="showDialog">
    <header class="form-header">
      <h2>{{ isReadOnly ? 'Plan Details' : 'Add New Inspection Plan' }}</h2>
      <button type="button" class="close-button" (click)="closeDialog()" aria-label="Close">×</button>
    </header>

    <form class="full-page-form" [formGroup]="form" (ngSubmit)="submit()">
      <section class="form-section">
        <div class="form-grid">
          <label>
            <span>Item ID *</span>
            <input type="text" formControlName="itemId" />
          </label>
          <label>
            <span>Item description *</span>
            <input type="text" formControlName="itemDescription" />
          </label>
          <label>
            <span>Doc number</span>
            <input type="text" formControlName="docNumber" />
          </label>
          <label>
            <span>Doc date</span>
            <input type="date" formControlName="docDate" />
          </label>
          <label>
            <span>Revision number</span>
            <input type="text" formControlName="revisionNumber" />
          </label>
          <label>
            <span>Prepared by</span>
            <input type="text" formControlName="preparedBy" />
          </label>
        </div>
      </section>

      <section class="form-section">
        <div class="section-header-row">
          <h3 class="section-title">Plan lines</h3>
          <button type="button" class="add-row-button" (click)="addDetailRow()" [disabled]="isReadOnly">+ Add row</button>
        </div>

        <div class="detail-items-container">
          <div class="detail-item-card" *ngFor="let group of details.controls; let i = index" [formGroup]="group">
            <div class="detail-item-header">
              <span class="item-number">#{{ i + 1 }}</span>
              <button
                type="button"
                class="remove-item-button"
                (click)="removeDetailRow(i)"
                [disabled]="isReadOnly || details.length === 1"
              >
                Remove
              </button>
            </div>

            <div class="detail-fields-grid">
              <label>
                <span>Parameter name *</span>
                <input type="text" formControlName="parameterName" />
              </label>
              <label>
                <span>Specifications *</span>
                <input type="text" formControlName="specifications" />
              </label>
              <label>
                <span>Results *</span>
                <input type="text" formControlName="results" />
              </label>
              <label>
                <span>Inspection method *</span>
                <input type="text" formControlName="inspectionMethod" />
              </label>
              <label class="full-width">
                <span>Remarks</span>
                <input type="text" formControlName="remarks" />
              </label>
            </div>
          </div>
        </div>
      </section>

     

      <div class="form-actions">
        <button type="button" class="secondary" (click)="closeDialog()">
          {{ isReadOnly ? 'Close' : 'Cancel' }}
        </button>
        <button
          *ngIf="!isReadOnly"
          type="submit"
          class="primary"
          [disabled]="isSaving"
        >
          {{ isSaving ? 'Saving…' : 'Save plan' }}
        </button>
        <p class="error" *ngIf="saveError">{{ saveError }}</p>
      </div>
    </form>
  </div>
</section>

