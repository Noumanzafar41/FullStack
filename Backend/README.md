# Backend Setup (SAP HANA Cloud)

This backend is configured for SAP BTP (Business Technology Platform) with SAP HANA Cloud database.

## Local Development Setup

1. **Duplicate `env.example` â†’ `.env`** and update with your HANA Cloud credentials:
   - `HANA_HOST`: HANA Cloud host (e.g. `your-hana-host.hana.trial-us10.hanacloud.ondemand.com`)
   - `HANA_PORT`: Port (usually `443` for HANA Cloud)
   - `HANA_USER`: Database user (e.g. `DBADMIN`)
   - `HANA_PASSWORD`: Database password
   - `HANA_DATABASE`: Database name (e.g. `HXE` for trial)
   - `HANA_ENCRYPT`: Set to `true` for encrypted connections
   - `HANA_SSL_VALIDATE_CERT`: Set to `false` for development (use `true` in production)
   - `PORT`: API port (default `3000`)
   - `HOST`: Host to bind to (default `0.0.0.0`)

2. **Install dependencies** (run inside `Backend`):
   ```bash
   npm install
   ```

3. **Ensure HANA Cloud is reachable** and the configured user has permissions to create tables.
   The app bootstraps the schema automatically; it will create all required tables when missing.

4. **Start the API**:
   ```bash
   npm run start
   ```

## SAP BTP / Cloud Foundry Deployment

### Prerequisites
- SAP BTP account with Cloud Foundry environment
- SAP HANA Cloud service instance provisioned
- Cloud Foundry CLI installed and logged in

### Deployment Steps

1. **Create HANA Cloud service instance** (if not already created):
   ```bash
   cf create-service hana hdi-shared hana-db
   ```

2. **Update `manifest.yml`**:
   - Update the application name if needed
   - Update the route to match your BTP subaccount
   - Ensure service name matches your HANA service instance

3. **Deploy the application**:
   ```bash
   cf push
   ```

   The application will:
   - Automatically bind to the HANA service via VCAP_SERVICES
   - Initialize the database schema on first startup
   - Bind to `0.0.0.0` for Cloud Foundry networking

### Service Binding

When deployed to Cloud Foundry, the HANA Cloud service credentials are automatically provided via `VCAP_SERVICES` environment variable. The application automatically detects and uses these credentials.

To manually bind a service:
```bash
cf bind-service backend-api hana-db
cf restart backend-api
```

## Database Schema

The application automatically creates the following tables on startup:

- **Users**: User authentication and profiles
- **ParameterMaster**: Parameter master data
- **ProductInspections**: Product inspection records
- **IncomingMaterialInspections**: Incoming material inspection records
- **ProductInspectionPlans**: Product inspection plans
- **IncomingMaterialInspectionPlans**: Incoming material inspection plans

All tables use HANA-compatible SQL syntax with:
- `INTEGER GENERATED BY DEFAULT AS IDENTITY` for auto-increment IDs
- `TIMESTAMP` for date/time fields
- `NCLOB` for large text fields
- `TINYINT` for boolean values (0/1)

## Authentication

Passwords are hashed with `bcrypt`. Use the Angular frontend to register/login against these endpoints.

## Troubleshooting

### Connection Issues
- Verify HANA Cloud service is running and accessible
- Check network connectivity and firewall rules
- Ensure credentials are correct in `.env` or VCAP_SERVICES

### Schema Creation Errors
- Verify database user has CREATE TABLE permissions
- Check HANA Cloud service plan supports schema creation
- Review application logs: `cf logs backend-api --recent`

### Port Binding Issues
- Ensure application binds to `0.0.0.0` (not `localhost`)
- Check `PORT` environment variable is set by Cloud Foundry

## Node.js Version

The project uses Node.js 18.20.0 (specified in `.nvmrc`). Cloud Foundry will use the version specified in `package.json` engines field.
